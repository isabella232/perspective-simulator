#!/usr/bin/env php
<?php
/**
 * Perspective command for the perspective simulator
 *
 * @package    Perspective
 * @subpackage Simulator
 * @author     Squiz Pty Ltd <products@squiz.net>
 * @copyright  2018 Squiz Pty Ltd (ABN 77 084 670 600)
 */

// Prepare script for cli run.
if (php_sapi_name() !== 'cli') {
    echo "This script must be run from the command line.\n";
    exit(1);
}

include_once dirname(__DIR__, 5).'/autoload.php';

error_reporting(E_ALL | E_STRICT);
ini_set('default_charset', 'UTF-8');
mb_internal_encoding('UTF-8');

// Get options
$opts = getopt(
    'p:hiS::',
    [
        'project:',
        'help',
        'install',
        'server::'
    ]
);

if (isset($opts['S']) === true || isset($opts['server']) === true) {
    $host = ($opts['S'] ?? $opts['server'] ?? 'localhost:8000');
    if (empty($host) === true) {
        $host = 'localhost:8000';
    }

    \PerspectiveSimulator\CLI\Terminal::printLine(sprintf('Perspective Simulator listening on: http://%s', $host));
    \PerspectiveSimulator\CLI\Terminal::printLine('Press Ctrl-C to quit.');
    $router = dirname(__DIR__, 2).'/Requests/Router.php';
    exec('php -S '.$host.' '.$router);
    exit(1);
}

$help = false;
if (isset($opts['h']) === true || isset($opts['help']) === true) {
    $help = true;
}

$install = false;
if (isset($opts['i']) === true || isset($opts['install']) === true) {
    $install = true;
}

$project = ($opts['p'] ?? $opts['project'] ?? null);

if ((isset($opts['i']) === true
    || isset($opts['install']) === true)
    && is_dir(\PerspectiveSimulator\Libs\FileSystem::getSimulatorDir()) === true
) {
    echo 'Perspective Simulator already installed.'."\n";
    exit;
}

$console = \PerspectiveSimulator\CLI\Console::getInstance();
$args    = [
    'project' => $project,
    'install' => $install,
    'help'    => $help,
    'argv'    => $argv,
];

if ($install === false) {
    $console->loadProject($project, $args);
}

$console->run($args);
